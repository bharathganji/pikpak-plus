version: "3.9"
services:
  web:
    build:
      context: ./pikpak-plus-client
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-/api}
        API_URL_INTERNAL: ${API_URL_INTERNAL:-http://server:5000}
    depends_on:
      - server
    ports:
      - "3000:3000"
    volumes:
      - ./pikpak-plus-client:/user/src/app
    environment:
      - FLASK_APP=${FLASK_APP:-app.py}
      - FLASK_DEBUG=${FLASK_DEBUG:-1}
      - IS_DEVELOPMENT=${IS_DEVELOPMENT:-false}
      - API_URL_INTERNAL=${API_URL_INTERNAL:-http://server:5000}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-/api}
      - USER=${USER:-${user}}
      - PASSWD=${PASSWD:-${passwd}}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - PROXY=${PROXY:-}
      - GH_TOKEN=${GH_TOKEN}
      - MAX_FILE_SIZE_GB=${MAX_FILE_SIZE_GB:-25}
      - TASK_STATUS_UPDATE_INTERVAL_MINUTES=${TASK_STATUS_UPDATE_INTERVAL_MINUTES:-15}
      - CLEANUP_INTERVAL_HOURS=${CLEANUP_INTERVAL_HOURS:-24}
      - TASK_RETENTION_HOURS=${TASK_RETENTION_HOURS:-24}
      - CACHE_TTL_SECONDS=${CACHE_TTL_SECONDS:-300}
      - QUOTA_CACHE_TTL_SECONDS=${QUOTA_CACHE_TTL_SECONDS:-10800}
      - VIP_INFO_CACHE_TTL_SECONDS=${VIP_INFO_CACHE_TTL_SECONDS:-604800}
      - DEFAULT_PAGE_SIZE=${DEFAULT_PAGE_SIZE:-25}
      - WEBDAV_GENERATION_INTERVAL_HOURS=${WEBDAV_GENERATION_INTERVAL_HOURS:-24}

  server:
    build: ./pikpak-plus-server
    restart: unless-stopped
    depends_on:
      - redis
    # ports:
    # - '5000:5000'
    # volumes:
    #   - ./pikpak-plus-server:/app
    environment:
      - FLASK_APP=${FLASK_APP:-app.py}
      - FLASK_DEBUG=${FLASK_DEBUG:-1}
      - IS_DEVELOPMENT=${IS_DEVELOPMENT:-false}
      - API_URL_INTERNAL=${API_URL_INTERNAL:-http://server:5000}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - USER=${USER:-${user}}
      - PASSWD=${PASSWD:-${passwd}}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - PROXY=${PROXY:-}
      - GH_TOKEN=${GH_TOKEN}
      - MAX_FILE_SIZE_GB=${MAX_FILE_SIZE_GB:-25}
      - TASK_STATUS_UPDATE_INTERVAL_MINUTES=${TASK_STATUS_UPDATE_INTERVAL_MINUTES:-15}
      - CLEANUP_INTERVAL_HOURS=${CLEANUP_INTERVAL_HOURS:-24}
      - TASK_RETENTION_HOURS=${TASK_RETENTION_HOURS:-24}
      - CACHE_TTL_SECONDS=${CACHE_TTL_SECONDS:-300}
      - QUOTA_CACHE_TTL_SECONDS=${QUOTA_CACHE_TTL_SECONDS:-10800}
      - VIP_INFO_CACHE_TTL_SECONDS=${VIP_INFO_CACHE_TTL_SECONDS:-604800}
      - DEFAULT_PAGE_SIZE=${DEFAULT_PAGE_SIZE:-25}
      - WEBDAV_GENERATION_INTERVAL_HOURS=${WEBDAV_GENERATION_INTERVAL_HOURS:-24}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health/ready"]
      interval: 2m
      timeout: 10s
      retries: 3
      start_period: 40s

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  redis_data:
